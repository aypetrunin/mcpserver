"""
Модуль конфигурации Qdrant (имена коллекций и схема данных).

Назначение модуля
=================
Этот модуль является **единой точкой доступа** к конфигурации,
связанной с Qdrant:

- именам коллекций (FAQ, services, products);
- спискам разрешённых payload-полей для каждой коллекции;
- управлению кешированием этих значений.

Ключевые принципы
=================
1. ❌ НЕ читаем env / settings на уровне импорта
2. ✅ Читаем настройки лениво — только при первом использовании
3. ✅ Кешируем значения на время жизни процесса
4. ✅ Имеем явную возможность сбросить кеши (для тестов)

Почему это важно
================
- init_runtime() может быть вызван ПОСЛЕ импорта модулей
- импорт должен быть "чистым", без побочных эффектов
- тесты не должны зависеть от порядка импортов
"""

from __future__ import annotations

from functools import lru_cache

from src.settings import get_settings


# ======================================================================
# Имена коллекций Qdrant
# ======================================================================


@lru_cache(maxsize=1)
def services_collection() -> str:
    """
    Возвращает имя коллекции Qdrant для данных об услугах.

    Что это:
    --------
    Коллекция, в которой хранятся:
    - описание услуги
    - показания
    - противопоказания
    - инструкции перед посещением
    и т.п.

    Почему это функция, а не константа:
    ----------------------------------
    ❌ Плохо:
        SERVICES_COLLECTION = get_settings().QDRANT_COLLECTION_SERVICES
        # ← выполнится при import

    ✅ Хорошо:
        services_collection()
        # ← выполнится только при первом вызове

    Почему используется lru_cache:
    ------------------------------
    - имя коллекции не меняется во время жизни процесса
    - вычисляем один раз → дальше берём из памяти
    """
    return get_settings().QDRANT_COLLECTION_SERVICES


@lru_cache(maxsize=1)
def faq_collection() -> str:
    """
    Возвращает имя коллекции Qdrant для FAQ.

    Что это:
    --------
    Коллекция, в которой лежат пары:
    - question
    - answer

    Используется:
    -------------
    - в FAQ tool
    - в retriever’ах для поиска ответов на организационные вопросы
    """
    return get_settings().QDRANT_COLLECTION_FAQ


@lru_cache(maxsize=1)
def products_collection() -> str:
    """
    Возвращает имя коллекции Qdrant для продуктов / услуг как товаров.

    Что это:
    --------
    Коллекция, в которой лежат:
    - product_id
    - product_name
    - duration
    - price_min / price_max
    - тип услуги и т.п.

    Используется:
    -------------
    - в retriever_product.py
    """
    return get_settings().QDRANT_COLLECTION_PRODUCTS


# ======================================================================
# Схема данных (какие поля читать из payload)
# ======================================================================


@lru_cache(maxsize=1)
def database_fields() -> dict[str, list[str]]:
    """
    Возвращает схему данных для Qdrant payload’ов.

    Формат:
    -------
    {
        <collection_name>: [<field1>, <field2>, ...]
    }

    Зачем это нужно:
    ----------------
    Qdrant возвращает payload целиком, но:
    - нам не нужны все поля
    - важно централизованно описать, какие поля разрешены
    - retriever’ы не должны "знать схему" данных

    Почему здесь, а не в retriever’ах:
    ----------------------------------
    - это конфигурация, а не логика
    - retriever → получает points → вызывает points_to_dict
    - points_to_dict → смотрит сюда и решает, что извлекать
    """
    s = get_settings()
    return {
        # FAQ: только вопрос и ответ
        s.QDRANT_COLLECTION_FAQ: [
            "question",
            "answer",
        ],
        # Services: расширенное описание услуги
        s.QDRANT_COLLECTION_SERVICES: [
            "services_name",
            "body_parts",
            "description",
            "contraindications",
            "indications",
            "pre_session_instructions",
        ],
        # Временная / служебная коллекция (legacy / mapping)
        "zena2_services_key": [
            "id",
            "services_name",
        ],
    }


# ======================================================================
# Управление кешами (для тестов и dev-сценариев)
# ======================================================================


def clear_qdrant_caches() -> None:
    """
    Сбрасывает ВСЕ lru_cache в этом модуле.

    Когда использовать:
    -------------------
    ✅ В тестах (pytest), если:
       - меняются env / settings
       - несколько тестов используют разные конфиги

    ✅ В dev / REPL, если:
       - вы меняли .env
       - не перезапускали процесс

    Когда НЕ использовать:
    ----------------------
    ❌ В продакшене
    ❌ В startup-коде приложения

    В проде:
    --------
    - настройки не меняются на лету
    - рестарт контейнера = чистые кеши
    """
    services_collection.cache_clear()
    faq_collection.cache_clear()
    products_collection.cache_clear()
    database_fields.cache_clear()
